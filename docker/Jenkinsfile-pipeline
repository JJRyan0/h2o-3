#! /usr/bin/groovy

def AGENT_LABEL = 'mr-0xc10'
def DOCKER_FILE_PATH = 'docker/Dockerfile'

pipeline {

    agent {
      label AGENT_LABEL
    }

    parameters {
      string(name: 'gitBranch', defaultValue: 'master', description: 'Branch to load the Dockerfile from.')
      choice(name: 'rVersion', defaultValue: '3.4.1', description: 'R Version to use', choices: '3.4.1\n3.3.3\n3.2.5\n3.1.3\n3.0.3')
      choice(name: 'pythonVersion', defaultValue: '2.7', description: 'Python Version to use', choices: '2.7\n3.5')
    }

    environment {
        H2O_GIT_URL = 'https://github.com/h2oai/h2o-3.git'
    }

    options {
        ansiColor('xterm')
        timestamps()
        timeout(time: 2, unit: 'HOURS')
    }

    stages {
        stage ('Checkout Sources') {
            steps {
              dir('h2o-3') {
                git url: env.H2O_GIT_URL, branch: params.gitBranch
              }
              mkdir -p "docker-home"
            }
        }

        stage ('Build Docker Image') {
          agent {
            dockerfile {
              label AGENT_LABEL
              filename DOCKER_FILE_PATH
              args "-v \$(pwd)/h2o-3/:/h2o-3 -v \$(pwd)/docker-home/:/h2o-3/?"
              reuseNode true
            }
          }

          steps {
            script {
              sh """
                  cd /h2o-3/docker
                  source /envs/h2o_env_python_${params.pythonVersion}
                  activate_R_${params.rVersion}
                  make build-h2o-3
              """
            }
          }
        }
    }

    post {
        failure {
            emailext (
                  subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                  body: """<p>FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
                    <p>Check console output at "<a href="${env.BUILD_URL}">${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>"</p>""",
                  to: "michalr@h2o.ai"
            )
        }
    }
}
